<!DOCTYPE html>
<html>
<head>
	<title>iTube</title>
	<link rel="stylesheet" type="text/css" href="https://unpkg.com/ant-design-vue@1.3.8/dist/antd.min.css">
</head>
<body>
	<div id="app">
		<a-row type="flex" justify="center" style="margin: 10px 0">
      <div style="margin-bottom: 16px">
        <a-input v-model="input">
          <a-select slot="addonBefore" v-model="typeOfInput" style="width: 90px">
            <a-select-option value="search">Search</a-select-option>
            <a-select-option value="playlist">Playlist</a-select-option>
            <a-select-option value="user_uploads">User's uploads</a-select-option>
          </a-select>
        </a-input>
      </div>
		</a-row>
		<a-row type="flex" justify="center" style="margin-bottom: 15px" v-show="!initialState">
			<vue-tube ref="youtube" :height="height" :width="width" @ready="onPlayerReady" @state-change="onPlayerStateChange" />
		</a-row>
		<a-row>
			<a-col :span="16" :offset="4">
				<a-row type="flex" justify="space-between">
					<a-card
					  hoverable
					  style="width: 240px; margin-bottom: 15px"
					  v-for="item of suggestionVideos"
					  :key="item.id"
					  @click="onCardClick(item.id || item.video.id)"
            :loading="loading"
					>
					  <img
              style="maxHeight: 240px"
					    :src="item.thumbnail.url || item.video.thumbnail.url"
					    slot="cover"
					  />
					  <a-card-meta>
              <p slot="title" :title="item.title || item.video.title">{{item.title || item.video.title}}</p>
					    <template slot="description">{{ item.duration || item.video.duration | duration }}</template>
					  </a-card-meta>
					</a-card>
				</a-row>
			</a-col>
		</a-row>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.7/dist/vue.js"></script>
	<script src="https://unpkg.com/ant-design-vue@1.3.8/dist/antd.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script>
    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    function onYouTubeIframeAPIReady() {
    	Vue.component('vue-tube', {
    		data() {
    			return {
			      player: {}
    			}
    		},
    		template: `
    			<div id="player"></div>
    		`,
    		props: ['height', 'width', 'videoId'],
    		mounted() {
    			this.player = new YT.Player('player', {
			      height: this.height,
			      width: this.width,
			      events: {
			      	'onReady': this.onPlayerReady,
			      	'onStateChange': this.onPlayerStateChange
			      }
			    });
    		},
    		methods: {
    			onPlayerReady(ev) {
			    	this.$emit('ready', ev);
			    },
			    onPlayerStateChange(ev) {
			    	this.$emit('state-change', ev);
			    }
    		}
    	})
    	const app = new Vue({
    		el: '#app',
    		data: {
    			height: '540',
		      width: '960',
		      API_KEY: 'AIzaSyCEFZFqOJqpQz5NZrU214nQr1yHIuaxDLg',
          typeOfInput: 'search',
		      input: '',
          initialState: true,
          suggestionVideos: [],
          loading: false
    		},
        computed: {
          player() {
            return this.$refs.youtube.player;
          }
        },
        filters: {
          duration(time) { // parse duration
            return time ? time.replace(/[M S PT]/g, match => match === 'M' ? ':' : '') : '';
          }
        },
        mounted() {
          this.initial();
        },
    		methods: {
          async initial() {
            const { data: { items } } = await axios.get(`https://www.googleapis.com/youtube/v3/videos?key=AIzaSyCEFZFqOJqpQz5NZrU214nQr1yHIuaxDLg&chart=mostPopular&regionCode=us&part=contentDetails,snippet&fields=items(id,snippet(title,thumbnails),contentDetails(duration))&maxResults=10`);
            const data = items.map(item => {
              const thumbnails = Object.values(item.snippet.thumbnails);
              return {
                id: item.id,
                title: item.snippet.title,
                thumbnail: thumbnails[thumbnails.length - 1],
                duration: item.contentDetails.duration
              }
            }).filter(item => item);
            this.suggestionVideos = data;
          },
    			async fetchData() {
            if(typeOfInput === 'search') {
              // const { data: { items } } = await axios.get(`https://www.googleapis.com/youtube/v3/search?key=AIzaSyCEFZFqOJqpQz5NZrU214nQr1yHIuaxDLg&relatedToVideoId=hA6hldpSTF8type=video&q=${this.input}&part=contentDetails,snippet&fields=items(id,snippet(title,thumbnails),contentDetails(duration))&maxResults=10`);
              // const data = items.map(item => {
              //   const thumbnails = Object.values(item.snippet.thumbnails);
              //     return {
              //       id: item.id,
              //       title: item.snippet.title,
              //       thumbnail: thumbnails[thumbnails.length - 1],
              //       duration: item.contentDetails.duration
              //     }
              // }).filter(item => item);
              // this.suggestionVideos = data;
            } else {
              const id = this.input.split(/[= ? &]/g).find((str, index, thisArr) => {
              	const listWord = thisArr.findIndex(item => item === 'list');
              	if(index === listWord + 1) return str;
              });
              let { data: { items } } = await axios.get(`https://www.googleapis.com/youtube/v3/playlistItems?playlistId=${id}&key=AIzaSyCEFZFqOJqpQz5NZrU214nQr1yHIuaxDLg&maxResults=10&part=snippet,contentDetails&fields=items(id,snippet(thumbnails),contentDetails(videoId))`);
              this.loading = true;
              this.player.cueVideoById(items[0].contentDetails.videoId);
              const data = items.map(item => {
                if(!item.snippet) return null;
                const thumbnails = Object.values(item.snippet.thumbnails);
                return {
                  id: item.id,
                  video: {
                    id: item.contentDetails.videoId,
                    thumbnail: thumbnails[thumbnails.length - 1],
                  }
                }
              }).filter(item => item);
              hanldePlaylistData(data);
              return;

            }
    			},
    			async hanldePlaylistData(data) {
            const videoIds = data.map(item => item.video.id).join(',');
            const res = await axios.get(`https://www.googleapis.com/youtube/v3/videos?id=${videoIds}&key=AIzaSyCEFZFqOJqpQz5NZrU214nQr1yHIuaxDLg&part=snippet,contentDetails&fields=items(snippet(title),contentDetails(duration))`);
            const videoResources = res.data.items;
            data = data.map((item, index) => {
              item.video.title = videoResources[index].snippet.title;
              item.video.duration = videoResources[index].contentDetails.duration;
              return item;
            });
            setTimeout(() => {
              this.loading = false;
            }, 500);
    			},
    			onCardClick(id) {
            this.initialState = false;
    				this.player.loadVideoById(id);
    			},
    			onPlayerReady(ev) {
			    },
			    onPlayerStateChange(ev) {
			    }
    		}
    	});
    }
  </script>
</body>
</html>